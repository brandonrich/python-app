name: Deploy to Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Docker image tag to deploy (e.g., sha-abc123 or latest)'
        required: true
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}

      - name: Deploy to ${{ inputs.environment }}
        id: deploy
        run: |
          # This is a demonstration deployment script
          # In production, this would:
          # - Use kubectl for Kubernetes
          # - Use AWS CLI for ECS/EC2
          # - Use SSH to remote servers
          # - Use cloud provider APIs

          echo "Deploying image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}"
          echo "Target environment: ${{ inputs.environment }}"

          # Example: Local Docker deployment (for demonstration)
          docker stop python-demo-app-${{ inputs.environment }} || true
          docker rm python-demo-app-${{ inputs.environment }} || true

          PORT=${{ inputs.environment == 'production' && '5001' || '5002' }}

          docker run -d \
            --name python-demo-app-${{ inputs.environment }} \
            -p ${PORT}:5000 \
            -e ENVIRONMENT=${{ inputs.environment }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}

          echo "url=http://localhost:${PORT}" >> $GITHUB_OUTPUT

      - name: Health check
        run: |
          sleep 5
          PORT=${{ inputs.environment == 'production' && '5001' || '5002' }}
          curl -f http://localhost:${PORT}/health || exit 1
          echo "✓ Health check passed for ${{ inputs.environment }}"

      - name: Post-deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✓ Successfully deployed to ${{ inputs.environment }}"
            echo "Image: ${{ inputs.image_tag }}"
            echo "Deployed by: ${{ github.actor }}"
          else
            echo "✗ Deployment to ${{ inputs.environment }} failed"
          fi
